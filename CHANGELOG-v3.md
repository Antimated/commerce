# Running Release Notes for Craft Commerce 3.0

> {warning} Order notification emails are now sent via a queue job, so running a queue worker as a daemon is highly recommended to avoid notification delays.

> {warning} Plugins and modules that modify the Edit Order page are likely to break with this update.

### Added
- Commerce 3.0 requires Craft 3.4 or later.
- Added the ability to create and edit orders from the control panel.
- Added the ability to manage customers and customer addresses from the control panel. ([#1043](https://github.com/craftcms/commerce/issues/1043))
- Added GraphQL support for products. ([#1092](https://github.com/craftcms/commerce/issues/1092))
- Added the ability to send emails from the Edit Order page.
- Line items can now be exported from the Orders index page. ([#976](https://github.com/craftcms/commerce/issues/976))
- Added the “Edit orders” and “Delete orders” user permissions.
- Line items now have a status that can be changed on Edit Order pages.
- Line items now have a Private Note field for store managers.
- Inactive carts are now purged during garbage collection.
- Orders now have recalculation modes to determine what should be recalculated on the order.
- Added the `origin` order query param.
- Added the `hasLineItems` order query param.
- `commerce/payments/pay` JSON responses now include an `orderErrors` array if there were any errors on the order.
- Added warnings to settings that are being overridden in the config file. ([#746](https://github.com/craftcms/commerce/issues/746))
- Promotions can now specify which elements are the source vs. target on category relations added by the promotion. ([#984](https://github.com/craftcms/commerce/issues/984))
- Added the ability to add products existing sales from Edit Product pages. ([#594](https://github.com/craftcms/commerce/issues/594))
- Added the ability to set a plain text template for Commerce emails. ([#1106](https://github.com/craftcms/commerce/issues/1106))
- Added the `showCustomerInfoTab` config setting, which determines whether Edit User pages should show a “Customer Info” tab. ([#1037](https://github.com/craftcms/commerce/issues/1037))
- Added the ability to create a percentage-based discount on the order total. ([#438](https://github.com/craftcms/commerce/issues/438))
- Added the ability to sort by customer attributes on the Orders index page. ([#1089](https://github.com/craftcms/commerce/issues/1089))
- Added the ability to set the title label for products and variants per product type. ([#244](https://github.com/craftcms/commerce/issues/244))
- Added the ability to enable/disabled countries and states. ([#213](https://github.com/craftcms/commerce/issues/213))
- Added the ability to show customer info on the Orders index page.
- Added `craft\commerce\base\Stat`.
- Added `craft\commerce\base\StatInterface`.
- Added `craft\commerce\base\StatTrait`.
- Added `craft\commerce\controllers\CountriesController::actionUpdateStatus()`.
- Added `craft\commerce\controllers\DiscountsController::actionClearDiscountUses()`.
- Added `craft\commerce\controllers\DiscountsController::actionUpdateStatus()`.
- Added `craft\commerce\controllers\DiscountsController::DISCOUNT_COUNTER_TYPE_CUSTOMER`.
- Added `craft\commerce\controllers\DiscountsController::DISCOUNT_COUNTER_TYPE_EMAIL`.
- Added `craft\commerce\controllers\DiscountsController::DISCOUNT_COUNTER_TYPE_TOTAL`.
- Added `craft\commerce\controllers\LineItemStatuses`.
- Added `craft\commerce\controllers\OrdersController::_getTransactionsWIthLevelsTableArray()`.
- Added `craft\commerce\controllers\OrdersController::actionNewOrder()`.
- Added `craft\commerce\controllers\SalesController::actionUpdateStatus()`.
- Added `craft\commerce\controllers\StatesController::actionUpdateStatus()`.
- Added `craft\commerce\elements\Order::$origin`.
- Added `craft\commerce\elements\Order::$recalculationMode`.
- Added `craft\commerce\elements\Order::getAdjustmentsByType()`.
- Added `craft\commerce\elements\Order::getCustomerLinkHtml()`.
- Added `craft\commerce\elements\Order::hasLineItems()`.
- Added `craft\commerce\models\Country::$enabled`.
- Added `craft\commerce\models\Customer::getCpEditUrl()`.
- Added `craft\commerce\models\Discount::$totalDiscountUseLimit`.
- Added `craft\commerce\models\Discount::$totalDiscountUses`.
- Added `craft\commerce\models\LineItem::$lineItemStatusId`.
- Added `craft\commerce\models\LineItem::$privateNote`.
- Added `craft\commerce\models\ProductType::$titleLabel`.
- Added `craft\commerce\models\ProductType::$variantTitleLabel`.
- Added `craft\commerce\models\State::$enabled`.
- Added `craft\commerce\queue\ConsolidateGuestOrders`.
- Added `craft\commerce\records\Country::$enabled`.
- Added `craft\commerce\records\LineItemStatus`.
- Added `craft\commerce\records\Purchasable::$description`.
- Added `craft\commerce\records\State::$enabled`.
- Added `craft\commerce\services\Countries::getAllEnabledCountries`.
- Added `craft\commerce\services\Countries::getAllEnabledCountriesAsList`.
- Added `craft\commerce\services\Discounts::clearCustomerUsageHistoryById()`.
- Added `craft\commerce\services\Discounts::clearDiscountUsesById()`.
- Added `craft\commerce\services\Discounts::clearEmailUsageHistoryById()`.
- Added `craft\commerce\services\Discounts::getCustomerUsageStatsById()`.
- Added `craft\commerce\services\Discounts::getEmailUsageStatsById()`.
- Added `craft\commerce\services\Emails::getAllEnabledEmails()`.
- Added `craft\commerce\services\LineItemStatuses::EVENT_DEFAULT_LINE_ITEM_STATUS`.
- Added `craft\commerce\services\LineItemStatuses`.
- Added `craft\commerce\services\States::getAllEnabledStates`.
- Added `craft\commerce\services\States::getAllEnabledStatesAsList`.
- Added `craft\commerce\services\States::getAllEnabledStatesAsListGroupedByCountryId`.
- Added `craft\commerce\services\States::getAllStatesAsListGroupedByCountryId`.
- Added `craft\commerce\web\assets\chartjs\ChartJsAsset`.
- Added `craft\commerce\web\assets\deepmerge\DeepMerge`.
- Added `craft\commerce\web\assets\statwidgets\StatWidgets`.
- Added `craft\commerce\widgets\AverageOrderTotal`.
- Added `craft\commerce\widgets\NewCustomers`.
- Added `craft\commerce\widgets\RepeatCustomers`.
- Added `craft\commerce\widgets\TopCustomers`.
- Added `craft\commerce\widgets\TopProducts`.
- Added `craft\commerce\widgets\TopProductTypes`.
- Added `craft\commerce\widgets\TopPurchasables`.
- Added `craft\commerce\widgets\TotalOrders`.
- Added `craft\commerce\widgets\TotalOrdersByCountry`.
- Added `craft\commerce\widgets\TotalRevenue`.

## Changed
- When a customer logs in, and their current guest cart is empty, their most recent cart that had items in it will be restored as the new current cart.
- The date range picker on the Orders index page has been moved to the page toolbar, and now affects which orders are shown in the order listing and which orders are included in order exports, rather than just affecting the chart.
- The Edit Order page is now a Vue app.
- Order status change emails are triggered by a queue job for faster checkout.
- When adding a donation to the cart, supplying a `donationAmount` parameter is no longer required. (Donations will default to zero if omitted.)
- `commerce/cart/*` actions now call `craft\commerce\elements\Order::toArray()` when generating the cart array for JSON responses.
- `commerce/payments/pay` JSON responses now list payment form errors under `paymentFormErrors` rather than `paymentForm`.
- Customer records that are anonymous and orphaned are now deleted during garbage collection.
- Changed the default category relationship type on promotions from `sourceElement` to `element`. ([#984](https://github.com/craftcms/commerce/issues/984))
- The `purgeInactiveCartsDuration` and `activeCartDuration` config settings now support all value formats supported by `craft\cms\helpers\ConfigHelper::durationInSeconds()`. ([#1071](https://github.com/craftcms/commerce/issues/1071))
- The `commerce/customer-addresses/save` action no long forces primary shipping and billing addresses if they do not exist. ([#1069](https://github.com/craftcms/commerce/issues/1069))
- Moved `craft\commerce\services\States::getAllStatesAsList()` logic to `craft\commerce\services\States::getAllStatesAsListGroupedByCountryId()` to be consistent with other service methods.
- The `allowEmptyCartOnCheckout` config setting is now set to `false` by default.
- Discount usage conditions now apply to the discount as a whole, rather than just the coupon code.
- Discounts’ user and email usage counters can be cleared individually.
- Addresses no longer require a first and last name.
- Guest orders are now consolidated with other orders from the same customer immediately after an order is completed, rather than when a user logs in. ([#1062](https://github.com/craftcms/commerce/issues/1062))
- It is no longer possible to merge previous carts automatically using the `mergeCarts` param.
- Removed the `mergeCarts` parameter from `craft\commerce\services\Carts::getCart()`.

## Deprecated
- Deprecated `craft\commerce\elements\Order::getShouldRecalculateAdjustments()` and `setShouldRecalculateAdjustments()`. `craft\commerce\elements\Order::$recalculationMode` should be used instead.
- Deprecated `craft\commerce\serviced\Customers::consolidateOrdersToUser()`. `craft\commerce\queue\ConsolidateGuestOrders` job should be used instead.
- Deprecated `craft\commerce\services\Orders::cartArray()`. `craft\commerce\elements\Order::toArray()` should be used instead.

## Removed
- Removed the Customer Info field type. ([#1037](https://github.com/craftcms/commerce/issues/1037))
- Removed the `craft.commerce.availableShippingMethods` Twig property.
- Removed the `craft.commerce.cart` Twig property.
- Removed the `craft.commerce.countriesList` Twig property.
- Removed the `craft.commerce.customer` Twig property.
- Removed the `craft.commerce.discountByCode` Twig property.
- Removed the `craft.commerce.primaryPaymentCurrency` Twig property.
- Removed the `craft.commerce.statesArray` Twig property.
- Removed the `commerce/cart/remove-all-line-items` action.
- Removed the `commerce/cart/remove-line-item` action.
- Removed the `commerce/cart/update-line-item` action.
- Removed `craft\commerce\base\Purchasable::getPurchasableId()`.
- Removed `craft\commerce\controllers\ChartsController`.
- Removed `craft\commerce\controllers\DiscountsController::actionClearCouponUsageHistory()`.
- Removed `craft\commerce\controllers\DownloadController::actionExportOrder()`.
- Removed `craft\commerce\elements\db\OrderQuery::updatedAfter()`.
- Removed `craft\commerce\elements\db\OrderQuery::updatedBefore()`.
- Removed `craft\commerce\elements\db\SubscriptionQuery::subscribedAfter()`.
- Removed `craft\commerce\elements\db\SubscriptionQuery::subscribedBefore()`.
- Removed `craft\commerce\elements\Order::getOrderLocale()`.
- Removed `craft\commerce\elements\Order::updateOrderPaidTotal()`.
- Removed `craft\commerce\elements\Product::getSnapshot()`.
- Removed `craft\commerce\elements\Product::getUnlimitedStock()`.
- Removed `craft\commerce\elements\Variant::getSalesApplied()`.
- Removed `craft\commerce\helpers\Order::mergeOrders()`.
- Removed `craft\commerce\models\Address::getFullName()`.
- Removed `craft\commerce\models\Discount::$totalUses`.
- Removed `craft\commerce\models\Discount::$totalUseLimit`.
- Removed `craft\commerce\models\Discount::getFreeShipping()`.
- Removed `craft\commerce\models\Discount::setFreeShipping()`.
- Removed `craft\commerce\models\LineItem::fillFromPurchasable()`.
- Removed `craft\commerce\models\Order::getDiscount()`.
- Removed `craft\commerce\models\Order::getShippingCost()`.
- Removed `craft\commerce\models\Order::getTax()`.
- Removed `craft\commerce\models\Order::getTaxIncluded()`.
- Removed `craft\commerce\models\ShippingMethod::$amount`.
- Removed `craft\commerce\services\Countries::getAllCountriesListData()`.
- Removed `craft\commerce\services\Discounts::clearCouponUsageHistoryById()`.
- Removed `craft\commerce\services\Gateways::getAllFrontEndGateways()`.
- Removed `craft\commerce\services\ShippingMethods::getOrderedAvailableShippingMethods()`.
- Removed `craft\commerce\services\Reports::getOrdersExportFile()`.
- Removed `craft\commerce\models\Address::EVENT_REGISTER_ADDRESS_VALIDATION_RULES` event. Use `craft\base\Model::EVENT_DEFINE_RULES` instead.
- Removed `craft\commerce\services\Reports::EVENT_BEFORE_GENERATE_EXPORT` event. Use `craft\base\Element::EVENT_REGISTER_EXPORTERS` to create your own exports.
- Removed `craft\commerce\web\assets\RevenueWidgetAsset`.
- Removed `craft\commerce\widgets\Revenue`. Use `craft\commerce\widgets\TotalRevenue` instead.
- Removed the `phpoffice/phpspreadsheet` package dependency.
