{% extends "commerce/_layouts/cp" %}
{% do view.registerAssetBundle('craft\\web\\assets\\admintable\\AdminTableAsset') -%}
{% do view.registerTranslations('commerce', [
  'Are you sure you want to delete this address?',
  'No Addresses available.',
  'No orders exist for this customer.',
  'Search customer orders',
  'Set as Primary Billing',
  'Set as Primary Shipping',
]) %}

{% set crumbs = [
  { label: 'Customers'|t('commerce'), url: url('commerce/customers') },
] %}

{% set selectedSubnavItem = 'customers' %}

{% set fullPageForm = true %}

{% import "_includes/forms" as forms %}

{% set addresses = customer.getAddresses() ?? null %}
{% set tableData = [] %}
{% for address in addresses %}
  {% set addressLines = [
    address.attention,
    address.title,
    address.firstName ~ ' ' ~ address.lastName|trim,
    address.fullName,
    address.address1,
    address.address2,
    address.address3,
    address.city,
    address.zipCode,
    address.phone,
    address.alternativePhone,
    address.label,
    address.notes,
    address.businessName,
    address.stateName,
    address.custom1,
    address.custom2,
    address.custom3,
    address.custom4,
  ]|filter(v => v) %}

  {% set tableData = tableData|merge([{
    id: address.id,
    title: address.address1,
    url: cpUrl('commerce/addresses/' ~ address.id),
    zipCode: address.zipCode,
    billing: (customer.primaryBillingAddressId == address.id),
    shipping: (customer.primaryShippingAddressId == address.id),
    detail: { handle: tag('span', { 'data-icon': 'info', title: 'Show full address'|t('commerce') }) , content: addressLines|join('<br>') }
  }]) %}
{% endfor %}

{% block content %}
  <h2>{{ 'Orders'|t('commerce') }}</h2>
  <div id="orders-vue-admin-table"></div>

  <hr>

  <h2>{{ 'Addresses'|t('commerce') }}</h2>
  <div id="addresses-vue-admin-table"></div>

  {# Hidden fields #}
  <input type="hidden" name="id" value="{{ customer.id }}">
  <input type="hidden" name="action" value="commerce/customers/save">
{% endblock %}

{% js %}
var orderColumns = [
    { name: '__slot:title', title: Craft.t('commerce', 'Order'), sortField: 'reference' },
    { name: 'date', title: Craft.t('commerce', 'Order Date'), sortField: 'dateOrdered' },
    { name: 'total', title: Craft.t('commerce', 'Total Paid'), sortField: 'totalPaid' },
    { name: 'orderStatus', title: Craft.t('commerce', 'Status'),
        callback: function(value) {
            return value;
        }
    }
];

new Craft.VueAdminTable({
    columns: orderColumns,
    container: '#orders-vue-admin-table',
    emptyMessage: Craft.t('commerce', 'No orders exist for this customer.'),
    padded: true,
    perPage: 10,
    tableData: [],
    // tableDataEndpoint: Craft.getActionUrl('commerce/orders/user-orders-table?customerId={{ customer.id }}'),
    search: true,
    searchPlaceholder: Craft.t('commerce', 'Search customer orders')
});

var columns = [
    { name: '__slot:title', title: Craft.t('commerce', 'Address 1') },
    { name: 'zipCode', title: Craft.t('commerce', 'Zip Code') },
    { name: 'billing', title: Craft.t('commerce', 'Primary Billing Address'), callback: function(value) {
        if (!value) {
            return '';
        }

        return '<span data-icon="check"></span>';
    } },
    { name: 'shipping', title: Craft.t('commerce', 'Primary Shipping Address'), callback: function(value) {
        if (!value) {
            return '';
        }

        return '<span data-icon="check"></span>';
    } },
    { name: '__slot:detail', title: '', titleClass: 'thin' },
];

var actions = [
    {
        label: '',
        icon: 'settings',
        actions: [
            {
                label: Craft.t('commerce', 'Set as Primary Billing'),
                action: 'commerce/addresses/set-primary',
                param: 'type',
                value: 'billing',
            },
            {
                label: Craft.t('commerce', 'Set as Primary Shipping'),
                action: 'commerce/addresses/set-primary',
                param: 'type',
                value: 'shipping',
            }
        ]
    }
];

new Craft.VueAdminTable({
    actions: actions,
    checkboxes: true,
    columns: columns,
    container: '#addresses-vue-admin-table',
    deleteAction: 'commerce/addresses/delete',
    deleteConfirmationMessage: Craft.t('commerece', 'Are you sure you want to delete this address?'),
    emptyMessage: Craft.t('commerce', 'No Addresses available.'),
    padded: true,
    tableData: {{ tableData|json_encode|raw }}
});
{% endjs %}