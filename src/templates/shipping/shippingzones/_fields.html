{% import "_includes/forms" as forms %}

{% do view.registerTranslations('commerce', [
"Invalid Condition Syntax",
"Valid Condition Syntax",
]) %}

<div>
{{ forms.textField({
    first: true,
    label: "Name"|t('commerce'),
    instructions: "What this shipping zone will be called in the CP."|t('commerce'),
    id: 'name',
    name: 'name',
    value: shippingZone is defined ? shippingZone.name,
    errors: shippingZone is defined ? shippingZone.getErrors('name'),
    autofocus: true,
    required: true
}) }}

{{ forms.textField({
    label: "Description"|t('commerce'),
    instructions: "Describe this shipping zone."|t('commerce'),
    id: 'description',
    name: 'description',
    value: shippingZone is defined ? shippingZone.description,
    errors: shippingZone is defined ? shippingZone.getErrors('description'),
}) }}

{{ forms.radioGroupField({
    label: 'Type'|t('commerce'),
    id: 'isCountryBased',
    name: 'isCountryBased',
    options: {1 : 'Country-based'|t('commerce'), 0 : 'State-based'|t},
    value: shippingZone is defined ? shippingZone.isCountryBased,
    errors: shippingZone is defined ? shippingZone.getErrors('isCountryBased'),
    required: true,
}) }}

{{ forms.multiselectField({
    label: 'Countries'|t('commerce'),
    instructions: 'Choose the countries that this zone applies to.'|t('commerce'),
    id: 'countries',
    name: 'countries',
    options: countries,
    values: shippingZone is defined ? shippingZone.getCountryIds(),
    errors: shippingZone is defined ? shippingZone.getErrors('countries'),
    required: true,
    class: 'selectize fullwidth',
}) }}

{{ forms.multiselectField({
    label: 'States'|t('commerce'),
    id: 'states',
    instructions: 'Choose the states that this zone applies to.'|t('commerce'),
    name: 'states',
    options: states,
    values: shippingZone is defined ? shippingZone.getStateIds(),
    errors: shippingZone is defined ? shippingZone.getErrors('states'),
    required: true,
    class: 'selectize fullwidth',
}) }}

<table class="inputs">
    <tr>
        <td style="padding-right: 28px; vertical-align:top">
            <div style="position:relative;">
            {{ forms.textareaField({
                label: 'Zip Code Condition Formula'|t('commerce'),
                id: 'zipCodeConditionFormula',
                rows: 5,
                instructions: 'Use a formula to match the zip code. Leave this blank to match all zip codes. Use the `zipCode` variable.  e.g `zipCode[0:2] == \'NG\'`'|t('commerce'),
                tip: 'This field uses the Twig expression sytax. <a href="https://twig.symfony.com/doc/2.x/templates.html#expressions" class="go">Learn More</a>',
                value: shippingZone.zipCodeConditionFormula,
                name: 'zipCodeConditionFormula',
                errors: shippingZone is defined ? shippingZone.getErrors('zipCodeConditionFormula'),
                class: 'fullwidth code'
            }) }}
            <div style="position:absolute; right: 0; bottom: -12px">
                <p id="validMessage" class="hidden"></p>
                <div id="validSpinner" style="" class="spinner hidden"></div>
            </div>
            </div>
        </td>
        <td>

        </td>
    </tr>
</table>

</div>
{% set countriesId = 'countries'|namespaceInputId|e('js') %}
{% set statesId = 'states'|namespaceInputId|e('js') %}
{% set isCountryBasedName = 'isCountryBased'|namespaceInputName|e('js') %}

{% js %}
    $('#{{ countriesId }}, #{{ statesId }}').selectize({
        plugins: ['remove_button'],
        dropdownParent: 'body'
    });

    $('[name="{{ isCountryBasedName }}"]').change(function () {
    if (!$(this).is(':checked')) {
        return;
    }

    if ($(this).val() * 1) {
        $('#{{ countriesId }}')[0].selectize.enable();
        $('#{{ statesId }}')[0].selectize.disable();
        $('#{{ countriesId }}-field').show();
        $('#{{ statesId }}-field').hide();
    } else {
        $('#{{ countriesId }}')[0].selectize.disable();
        $('#{{ statesId }}')[0].selectize.enable();
        $('#{{ countriesId }}-field').hide();
        $('#{{ statesId }}-field').show();
    }
    });

    $('[name="{{ isCountryBasedName }}"]:checked').trigger('change');

    // setup for debouncing
    var typingTimer;                //timer identifier
    var doneTypingInterval = 1000;  //time in ms, 5 second for example
    var $zipCodeConditionFormula = $('#zipCodeConditionFormula');
    var $testZipCode = $('#testZipCode');
    var $validMessage = $('#validMessage');

    //on keyup, start the countdown
    $zipCodeConditionFormula.on('keyup', function () {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(doneTyping, doneTypingInterval);
        $('#validSpinner').removeClass('hidden');
        $validMessage.addClass('hidden');
    });

    //on keydown, clear the countdown
    $zipCodeConditionFormula.on('keydown', function () {
        clearTimeout(typingTimer);
    });

    //user is "finished typing," do something
    function doneTyping () {
        $.post({
            url: Craft.getActionUrl('commerce/formulas/validate-condition'),
            data: { condition: $zipCodeConditionFormula.val(), params: { zipCode : '' }},
            dataType: 'json',
            headers: {
                'X-CSRF-Token': Craft.csrfTokenValue
            },
            success: function(data){
                $('#validSpinner').addClass('hidden');

                if(data.hasOwnProperty('error')){
                    $validMessage.text(Craft.t('commerce', 'Invalid Condition Syntax'));
                    $validMessage.css('color','#da5a47');
                    $validMessage.removeClass('hidden');
                }else{
                    $validMessage.text(Craft.t('commerce', 'Valid Condition Syntax'));
                    $validMessage.css('color','#00b007');
                    $validMessage.removeClass('hidden');
                }
            }
        });
    }
{% endjs %}
